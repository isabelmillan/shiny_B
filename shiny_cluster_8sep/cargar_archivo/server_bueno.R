options(shiny.maxRequestSize = 1000*1024^2)
library(cluster)
library(fpc)
library(rpart)
library(factoextra)
#source("utiles.R")

shinyServer(function(input, output) {
  
  
  # Function that imports the data file
  dInput = reactive({
    in.file = input$file1
    
    if (is.null(in.file))
      return(NULL)
    
    data <- read.csv(in.file$datapath, na.strings=c(".", "NA", "", "?"))
    
  })
  
  # Function that render the data file and passes it to ui.R
  output$view = renderTable({
    d.input = dInput()
    if (is.null(d.input)) return(NULL)
    if (ncol(d.input>10)) d.input = d.input[] #$,1:10]
    head(dInput(), n=50)  
  })
  
  # Check boxes
  output$choose_columns <- renderUI({
    # If missing input, return to avoid error later in function
    d.input = dInput()
    if(is.null(d.input))
      return()
    
    # Get the data set with the appropriate name
    #dat <- get(input$file1)
    colnames <- names(d.input)
    
    # Create the checkboxes and select them all by default
    checkboxGroupInput("columns", "Choose columns", 
                       choices  = colnames,
                       selected = colnames)
  })
  
  # Target variable selection
  output$choose_target <- renderUI({
    # If missing input, return to avoid error later in function
    d.input = dInput()
    if(is.null(d.input))
      return()
    
    # Get the data set with the appropriate name
    
    colnames <- names(d.input)
    
    # Create the checkboxes and select them all by default
    selectInput("target", "Choose Target Attribute", 
                choices  = colnames)#,
    # selected = colnames)
  })
  #k-means cluster
  
  selectedData <- reactive({
    d.input = dInput()
    dat_cluster <- d.input
    dat_cluster <- dat_cluster[, input$columns, drop = FALSE]
    for (x in 1:length(dat_cluster))      # Transform the variables
    { 
      if(!is.numeric(dat_cluster[,x])) {
        column <- paste(colnames(dat_cluster)[x],"transformed",sep="_")
        temp_data <- as.numeric(dat_cluster[,x])
        temp_mat <- matrix(c(temp_data),ncol=1,byrow=TRUE)
        colnames(temp_mat) <- column
        data_clust_trans <- cbind(dat_cluster,temp_mat)
      }
      
    }
    nums <- sapply(dat_cluster, is.numeric)  
    dat_cluster_numeric <- dat_cluster[,nums]  #Considered only numeric values for K-Means
    dat_cluster_numeric[is.na(dat_cluster_numeric)]=FALSE
    
    dat_cluster_numeric
    
  })	
  clusters <- reactive({
    
    kmeans(selectedData(), input$clusters)
  })
  
  output$kmeans_plot <- renderPlot({
    
    clusplot(selectedData(), clusters()$cluster, color=clusters()$cluster, labels=clusters()$cluster, cex=1.0, shade=TRUE,lines=0)
  })
  
  output$clust_table <- renderTable({
    clust_table <- cbind(selectedData(), by=list(cluster=clusters()$cluster))
    clust_table
  })
  
  output$agg_table <- renderTable({
    agg_table <-  aggregate(selectedData(), by=list(cluster=clusters()$cluster),mean)
    agg_table
  })
  
})